<!--
  App Toolkit API workspace

  Purpose:
  - This page lets us build and maintain the JSON catalog that powers the App Toolkit app.
  - It mirrors the production schema (debug + release), so we can safely edit, preview, and publish.

  Integration:
  - JavaScript logic for this workspace lives in the App Toolkit builder module (appToolkit.js).
  - JS selects this page by #appToolkitPage and #appToolkitBuilder, then wires:
    - Insight counters (tracked apps, release ready, screenshot averages)
    - Builder toolbar actions (add app, sort, reset)
    - Quick fetch presets (debug / release)
    - GitHub publish wizard and collapsible controls
    - JSON preview, validation, and diff side sheet

  Design:
  - Uses Material Web Components (md-*) for cards, buttons, menus, dialogs, steppers, etc.
  - Layout is controlled via CSS (api-builder.css, cards.css, text-fields.css, scroll.css).
  - The builder layout is a two-column grid (forms + preview) with an optional diff side sheet.

  Notes for agents:
  - When modifying this file, keep IDs and data-* attributes stable unless you also update
    the corresponding JS (appToolkit.js) and tests.
  - New structural elements should be documented with a short comment describing:
    - What the section shows
    - How JS interacts with it (if at all)
    - Any UX assumptions (e.g., “insights rely on live preview data”)
-->

<div id="appToolkitPage" class="page-section app-shell-panel active">
  <!-- Page header: static description of what this workspace does -->
  <header class="page-header">
    <h1>App Toolkit API workspace</h1>
    <p>
      Configure the JSON payload that powers the App Toolkit catalog. The
      builder mirrors the production schema so you can manage listings for both
      debug and release channels with confidence.
    </p>
  </header>

  <!--
    Workspace dashboard:
    - High-level metrics that summarize the current workspace state.
    - JS updates the values by ID using the current JSON snapshot from the builder.
  -->
  <section class="workspace-dashboard" aria-label="Workspace overview">
    <div class="workspace-insight-grid">
      <!-- Insight: how many apps are currently in the workspace -->
      <md-elevated-card class="insight-card">
        <div class="insight-card-header">
          <span class="material-symbols-outlined insight-icon">apps</span>
          <span class="insight-label">Apps in workspace</span>
        </div>
        <p class="insight-value" id="appToolkitTrackedCount">0</p>
        <p class="insight-helper">Live count mirrors the JSON preview.</p>
      </md-elevated-card>

      <!-- Insight: how many entries pass the "release ready" rules -->
      <md-elevated-card class="insight-card">
        <div class="insight-card-header">
          <span class="material-symbols-outlined insight-icon">rocket_launch</span>
          <span class="insight-label">Release ready</span>
        </div>
        <p class="insight-value" id="appToolkitReleaseReadyCount">0</p>
        <p class="insight-helper">Entries with rich media and required fields.</p>
      </md-elevated-card>

      <!-- Insight: average screenshot count across all apps -->
      <md-elevated-card class="insight-card">
        <div class="insight-card-header">
          <span class="material-symbols-outlined insight-icon">photo_library</span>
          <span class="insight-label">Screenshot average</span>
        </div>
        <p class="insight-value" id="appToolkitScreenshotAverage">0</p>
        <p class="insight-helper">Target three or more images per listing.</p>
      </md-elevated-card>
    </div>

    <!--
      Secondary dashboard:
      - "Today's pipeline" gives a narrative checklist.
      - "Release readiness" shows overall progress across debug / release.
      - Both are driven by counters and validation logic in appToolkit.js.
    -->
    <div class="workspace-secondary-grid">
      <md-filled-card class="workspace-plan">
        <div class="card-body">
          <div class="plan-header">
            <h2>Today's pipeline</h2>
            <span class="plan-updated">Updated <span id="appToolkitLastEdited">awaiting changes</span></span>
          </div>
          <ol class="plan-list">
            <li>
              <span class="plan-step-title">Curate metadata</span>
              <span class="plan-step-meta" id="appToolkitReviewCount">0 entries queued</span>
            </li>
            <li>
              <span class="plan-step-title">Validate JSON preview</span>
              <span class="plan-step-meta">Keep status green before publishing.</span>
            </li>
            <li>
              <span class="plan-step-title">Publish to GitHub</span>
              <span class="plan-step-meta">Ship debug and release catalogs together.</span>
            </li>
          </ol>
        </div>
      </md-filled-card>

      <md-filled-card class="workspace-release">
        <div class="card-body">
          <div class="release-header">
            <h2>Release readiness</h2>
            <p id="appToolkitWorkspacePulse">Review entries to unlock insights.</p>
          </div>
          <!--
            Progress bar:
            - JS updates #appToolkitReleaseProgress to reflect readiness across channels.
            - Legend shows how debug vs release contribute to the bar.
          -->
          <div class="release-progress" role="img" aria-label="Release readiness progress">
            <div class="release-progress-track">
              <div class="release-progress-bar" id="appToolkitReleaseProgress"></div>
            </div>
            <div class="release-progress-legend">
              <span>Debug</span>
              <span>Release</span>
            </div>
          </div>
          <ul class="release-tips">
            <li>Add icons and three screenshots to unlock release readiness.</li>
            <li>Use quick presets below to pull the latest production data.</li>
          </ul>
        </div>
      </md-filled-card>
    </div>
  </section>

  <!--
    Guidance card:
    - Static checklist of schema and workflow rules.
    - JS does not mutate this; it's a source of truth for required fields.
  -->
  <md-filled-card class="guidance-card">
    <div class="card-body">
      <h2>Before you start</h2>
      <ul>
        <li>
          Each app entry must include <strong>name</strong>,
          <strong>packageName</strong>, a <strong>category</strong> with
          <code>label</code> and <code>category_id</code>, and an
          <strong>iconLogo</strong> URL.
        </li>
        <li>
          Screenshots appear in the same order they are added. Provide at least
          three URLs for release builds.
        </li>
        <li>
          When you are done, export the JSON and replace the existing file in
          <code>api/app_toolkit/v2/[debug|release]/en/home/api_android_apps.json</code>
          to mirror the production structure.
        </li>
        <li>
          Use <strong>Fetch existing JSON</strong> to pull the latest data from a
          remote file before editing.
        </li>
      </ul>
    </div>
  </md-filled-card>

  <!--
    Core builder section:

    - Root hook for JS: #appToolkitBuilder (data-builder-type="app-toolkit").
    - The JS module:
      - Renders the list of app entries into #appToolkitEntries.
      - Keeps #appToolkitPreview synced with the current JSON.
      - Drives validation + toolbar status + diff side sheet.
  -->
  <section
          class="api-builder"
          id="appToolkitBuilder"
          data-builder-type="app-toolkit"
  >
    <!--
      Builder toolbar:
      - Primary actions: Add app, Sort, Clear workspace.
      - Secondary status: Workspace pulse text on the right.
    -->
    <div class="builder-toolbar">
      <div class="builder-toolbar-actions">
        <!-- Add a new empty app entry -->
        <md-filled-button id="appToolkitAddApp" has-icon>
          <md-icon slot="icon">
            <span class="material-symbols-outlined">add</span>
          </md-icon>
          Add app
        </md-filled-button>

        <!-- Sort menu trigger; JS syncs label + menu selection -->
        <md-outlined-button
                id="appToolkitSortButton"
                has-icon
                trailing-icon
                aria-haspopup="menu"
                aria-expanded="false"
        >
          <md-icon slot="icon">
            <span class="material-symbols-outlined">sort</span>
          </md-icon>
          <span class="builder-sort-label">
            Sort · <span id="appToolkitSortLabel">App name (A–Z)</span>
          </span>
          <md-icon slot="trailing-icon">
            <span class="material-symbols-outlined">arrow_drop_down</span>
          </md-icon>
        </md-outlined-button>

        <!-- Sort options; JS applies 'data-sort-key' to the app list -->
        <md-menu id="appToolkitSortMenu" anchor="appToolkitSortButton">
          <md-menu-item type="radio" data-sort-key="name" selected>
            <div slot="headline">App name (A–Z)</div>
          </md-menu-item>
          <md-menu-item type="radio" data-sort-key="category">
            <div slot="headline">Category (A–Z)</div>
          </md-menu-item>
          <md-menu-item type="radio" data-sort-key="screenshots">
            <div slot="headline">Screenshot count (high to low)</div>
          </md-menu-item>
        </md-menu>

        <!-- Clear all entries and reset builder state -->
        <md-text-button id="appToolkitResetButton" has-icon>
          <md-icon slot="icon">
            <span class="material-symbols-outlined">refresh</span>
          </md-icon>
          Clear workspace
        </md-text-button>
      </div>

      <!-- Live textual summary of workspace health -->
      <div class="builder-toolbar-meta">
        <div class="toolbar-status" role="status" aria-live="polite">
          <span class="toolbar-status-label">Workspace pulse</span>
          <span class="toolbar-status-value" id="appToolkitToolbarPulse">Awaiting input</span>
        </div>
      </div>
    </div>

    <!--
      Quick fetch:
      - Preset shortcuts that load JSON from local paths (debug / release).
      - JS listens on #appToolkitDebugPreset / #appToolkitReleasePreset and
        populates the builder from those files.
    -->
    <div class="builder-remote-inline-action builder-toolbar-fetch-card" id="appToolkitRemoteImport">
      <div class="builder-toolbar-fetch">
        <div>
          <h2 class="builder-toolbar-title">Quick fetch</h2>
          <p class="builder-toolbar-helper">
            Use shortcuts to pull the latest catalog before editing entries.
          </p>
        </div>
        <div
                class="builder-remote-presets builder-remote-presets--buttons builder-toolbar-fetch__presets"
                aria-label="Quick fetch shortcuts"
                id="appToolkitFetchFieldset"
        >
          <span class="builder-remote-presets-label">Quick links</span>

          <!-- Debug preset: loads the debug catalog for EN -->
          <md-text-button
                  class="builder-remote-inline-button"
                  has-icon
                  data-app-toolkit-preset="./api/app_toolkit/v2/debug/en/home/api_android_apps.json"
                  id="appToolkitDebugPreset"
          >
            <md-icon slot="icon">
              <span class="material-symbols-outlined">download</span>
            </md-icon>
            Debug · EN
          </md-text-button>

          <!-- Release preset: loads the release catalog for EN -->
          <md-text-button
                  class="builder-remote-inline-button"
                  has-icon
                  data-app-toolkit-preset="./api/app_toolkit/v2/release/en/home/api_android_apps.json"
                  id="appToolkitReleasePreset"
          >
            <md-icon slot="icon">
              <span class="material-symbols-outlined">download</span>
            </md-icon>
            Release · EN
          </md-text-button>
        </div>
      </div>
    </div>

    <!--
      GitHub publish card:
      - Collapsible card that holds GitHub-specific guidance and controls.
      - JS wires the toggle and opens the dialog when "Open publish wizard" is used.
    -->
    <md-filled-card class="builder-remote-card" id="appToolkitGithubCard" data-collapsible-card data-collapsed="true">
      <div class="card-body">
        <div class="builder-remote-header builder-remote-header--split">
          <div class="builder-remote-title">
            <h2>Publish to GitHub</h2>
            <p>Push catalog updates directly from the workspace.</p>
          </div>
          <div class="builder-remote-actions">
            <!-- Launches the stepper dialog (GitHub wizard) -->
            <md-filled-button id="appToolkitGithubWizardButton" class="builder-github-launch-button" has-icon>
              <md-icon slot="icon">
                <span class="material-symbols-outlined">rocket_launch</span>
              </md-icon>
              Open publish wizard
            </md-filled-button>

            <!-- Collapsible meta controls for GitHub publishing -->
            <md-icon-button
                    id="appToolkitGithubToggle"
                    class="builder-remote-toggle"
                    data-collapsible-toggle
                    aria-expanded="false"
                    aria-controls="appToolkitGithubContent"
                    type="button"
                    aria-label="Toggle Publish to GitHub controls"
            >
              <md-icon>
                <span class="material-symbols-outlined" data-collapsible-indicator aria-hidden="true">
                  expand_more
                </span>
              </md-icon>
            </md-icon-button>
          </div>
        </div>

        <!-- Collapsible GitHub helper content; initially hidden -->
        <div class="builder-github-content" id="appToolkitGithubContent" data-collapsible-content hidden>
          <div class="builder-remote-header">
            <div>
              <p>
                Use the GitHub Contents API to update the catalog once the JSON
                preview is valid. Tokens are used only for this request and never
                stored.
              </p>
            </div>
          </div>
          <div class="builder-github-note" role="note">
            <p>
              <strong>Create a personal access token</strong> from
              <em>GitHub → Settings → Developer settings → Personal access tokens</em>.
              Choose a fine-grained token when possible and limit it to the
              repository you are publishing.
            </p>
            <ul>
              <li>
                Fine-grained tokens: enable
                <strong>Repository permissions → Contents: Read &amp; write</strong>
                (Metadata is added automatically).
              </li>
              <li>
                Classic tokens: select only
                <code>public_repo</code> for public catalogs or
                <code>repo</code> for private catalogs.
              </li>
              <li>Copy the token once and keep it outside of source control.</li>
            </ul>
          </div>
          <div class="builder-github-launch">
            <p class="builder-github-helper">
              Validate the preview first, then follow the guided steps to publish.
            </p>
          </div>
        </div>
      </div>
    </md-filled-card>

    <!--
      Builder layout grid:
      - Left: dynamic list of app entries (forms).
      - Middle/right: JSON preview and validation.
      - Optional: diff side sheet for comparing current vs last exported payload.
    -->
    <div class="builder-layout builder-columns">
      <!-- JS injects app entry forms here -->
      <div class="builder-forms" id="appToolkitEntries" aria-live="polite"></div>

      <!-- JSON preview column -->
      <aside class="builder-preview" aria-label="JSON preview">
        <div class="preview-header">
          <h2>Preview &amp; export</h2>
          <p>Changes update automatically as you edit entries.</p>
        </div>
        <textarea
                id="appToolkitPreview"
                class="preview-textarea"
                readonly
                spellcheck="false"
                aria-label="App Toolkit JSON preview"
        ></textarea>
        <div
                class="preview-validation"
                id="appToolkitValidation"
                role="status"
                aria-live="polite"
        ></div>
        <div class="preview-actions">
          <!-- Copy current JSON to clipboard -->
          <md-filled-tonal-button id="appToolkitCopyButton" has-icon>
            <md-icon slot="icon">
              <span class="material-symbols-outlined">content_copy</span>
            </md-icon>
            Copy JSON
          </md-filled-tonal-button>

          <!-- Download current JSON to a file -->
          <md-outlined-button
                  id="appToolkitDownloadButton"
                  has-icon
                  trailing-icon
          >
            Download
            <md-icon slot="icon">
              <span class="material-symbols-outlined">download</span>
            </md-icon>
          </md-outlined-button>
        </div>
      </aside>

      <!--
        Diff side sheet:
        - Hidden by default, opened when user asks to compare against the last exported payload.
        - JS populates #appToolkitDiffContent with a diff view.
      -->
      <md-side-sheet
              id="appToolkitDiffSheet"
              class="builder-diff-sheet"
              aria-label="Workspace diff"
      >
        <div slot="headline">Workspace diff</div>
        <div slot="supporting-text">
          Compare the current workspace against the last exported payload.
        </div>
        <div slot="content" class="diff-sheet-content">
          <div
                  id="appToolkitDiffContent"
                  class="diff-view diff-view--empty"
                  role="status"
                  aria-live="polite"
          ></div>
        </div>
      </md-side-sheet>
    </div>
  </section>

  <!--
    GitHub publish dialog (wizard):

    - md-steppers guides the user through:
      1) Authenticate (token)
      2) Target (repo / branch / message / channel)
      3) Review & publish

    - appToolkit.js controls:
      - Step transitions (Next/Back)
      - Token file loading
      - API calls to GitHub
      - Status messaging in #appToolkitGithubStatus
  -->
  <md-dialog id="appToolkitGithubDialog" class="app-dialog github-dialog">
    <div slot="headline">Publish to GitHub</div>
    <div slot="content" class="github-dialog-content">
      <md-steppers id="appToolkitGithubStepper" value="authenticate">
        <!-- Step 1: authenticate with a personal access token -->
        <md-step value="authenticate" label="Authenticate">
          <div class="github-step" data-step="authenticate">
            <md-outlined-text-field
                    id="appToolkitGithubToken"
                    label="Personal access token"
                    type="password"
                    autocomplete="off"
                    spellcheck="false"
                    supporting-text="Tokens require Contents: Read &amp; write access."
            ></md-outlined-text-field>
            <div class="github-step-actions">
              <input
                      type="file"
                      id="appToolkitGithubTokenFile"
                      accept="text/plain,.txt,.token"
                      hidden
              />
              <md-outlined-button id="appToolkitGithubTokenFileButton" has-icon>
                <md-icon slot="icon">
                  <span class="material-symbols-outlined">description</span>
                </md-icon>
                Load token from file
              </md-outlined-button>
            </div>
          </div>
        </md-step>

        <!-- Step 2: choose repo, branch, commit message, and target channel -->
        <md-step value="target" label="Target">
          <div class="github-step" data-step="target">
            <md-outlined-text-field
                    id="appToolkitGithubRepo"
                    label="Repository (owner/name)"
                    value="MihaiCristianCondrea/com.d4rk.apis"
                    supporting-text="Use owner/name format."
                    spellcheck="false"
            ></md-outlined-text-field>
            <md-outlined-text-field
                    id="appToolkitGithubBranch"
                    label="Branch"
                    value="main"
                    spellcheck="false"
            ></md-outlined-text-field>
            <md-outlined-text-field
                    id="appToolkitGithubMessage"
                    label="Commit message"
                    value="chore(app-toolkit): update catalog"
                    spellcheck="false"
            ></md-outlined-text-field>
            <md-outlined-select
                    id="appToolkitGithubChannel"
                    label="Target channel"
                    value="debug"
            >
              <md-select-option value="debug">Debug</md-select-option>
              <md-select-option value="release">Release</md-select-option>
              <md-select-option value="both">Debug &amp; Release</md-select-option>
            </md-outlined-select>
          </div>
        </md-step>

        <!-- Step 3: review diff and publish -->
        <md-step value="review" label="Review">
          <div class="github-step" data-step="review">
            <p class="github-review-copy">
              Confirm the diff in the side sheet and publish when ready.
            </p>
            <div class="github-status" id="appToolkitGithubStatus" role="status" aria-live="polite"></div>
          </div>
        </md-step>
      </md-steppers>
    </div>

    <!-- Dialog action buttons (Back / Next handled by JS) -->
    <div slot="actions" class="github-dialog-actions">
      <md-text-button dialog-action="close">Cancel</md-text-button>
      <md-text-button id="appToolkitGithubBack">Back</md-text-button>
      <md-filled-button id="appToolkitGithubNext" data-dialog-initial-focus>Next</md-filled-button>
    </div>
  </md-dialog>
</div>
